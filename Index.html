<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script src="scripts/three.js"></script>

		<script>
			startTime = new Date();
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

			var listener = new THREE.AudioListener();
			camera.add( listener );
			var sound = new THREE.Audio( listener );
			var audioLoader = new THREE.AudioLoader();
			audioLoader.load( 'no-way-out.mp3', function( buffer ) {
				sound.setBuffer( buffer );
				sound.setLoop(false);
				sound.setVolume(0.5);
				sound.play();
			});
			var analyser = new THREE.AudioAnalyser( sound, 32 );

			var beatlistener = new THREE.AudioListener();
			camera.add( beatlistener );
			var beatsound = new THREE.Audio( beatlistener );
			var beataudioLoader = new THREE.AudioLoader();
			beataudioLoader.load( 'beat.mp3', function( beatbuffer ) {
				beatsound.setBuffer( beatbuffer );
				beatsound.setLoop(false);
				beatsound.setVolume(0.01);
				beatsound.play();
			});
			var beatanalyser = new THREE.AudioAnalyser( beatsound, 32 );

			var leadlistener = new THREE.AudioListener();
			camera.add( leadlistener );
			var leadsound = new THREE.Audio( leadlistener );
			var leadaudioLoader = new THREE.AudioLoader();
			leadaudioLoader.load( 'lead.mp3', function( leadbuffer ) {
				leadsound.setBuffer( leadbuffer );
				leadsound.setLoop(false);
				leadsound.setVolume(0.01);
				leadsound.play();
			});
			var leadanalyser = new THREE.AudioAnalyser( leadsound, 32 );

			var arplistener = new THREE.AudioListener();
			camera.add( arplistener );
			var arpsound = new THREE.Audio( arplistener );
			var arpaudioLoader = new THREE.AudioLoader();
			arpaudioLoader.load( 'arpeggio.mp3', function( arpbuffer ) {
				arpsound.setBuffer( arpbuffer );
				arpsound.setLoop(false);
				arpsound.setVolume(0.01);
				arpsound.play();
			});
			var arpanalyser = new THREE.AudioAnalyser( arpsound, 32 );

			var basslistener = new THREE.AudioListener();
			camera.add( basslistener );
			var basssound = new THREE.Audio( arplistener );
			var bassaudioLoader = new THREE.AudioLoader();
			bassaudioLoader.load( 'bass.mp3', function( bassbuffer ) {
				basssound.setBuffer( bassbuffer );
				basssound.setLoop(false);
				basssound.setVolume(0.01);
				basssound.play();
			});
			var bassanalyser = new THREE.AudioAnalyser( basssound, 32 );

			//var dat = analyser.getAverageFrequency();

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			var geometry = new THREE.BoxGeometry( 1, 1, 1 );
			var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
			var cube = new THREE.Mesh( geometry, material );
			cube.position.set(0,0,0);
			scene.add( cube );

			var geometry = new THREE.CircleGeometry( 0.001, 30 );
			var material = new THREE.MeshBasicMaterial( { color: 0xffffff} );
			var circle1 = new THREE.Mesh( geometry, material );
			var circle2 = new THREE.Mesh( geometry, material );
			var circle3 = new THREE.Mesh( geometry, material );
			circle1.position.set(-2,-2,0);
			circle2.position.set(-2,-2,0);
			circle3.position.set(-2,-2,0);
			scene.add( circle1 );
			scene.add( circle2 );
			scene.add( circle3 );


			var dirLight = new THREE.DirectionalLight( 0xffffff, 0.125 );
			dirLight.position.set( 0, 0, 1 ).normalize();
			scene.add( dirLight );
			var pointLight = new THREE.PointLight( 0xffffff, 1.5 );
			pointLight.position.set( 0, 100, 90 );
			scene.add( pointLight );

			var text = "Hello Evoke. This is a very long text. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet."
			var textMesh = undefined;

			var loader = new THREE.FontLoader();
			loader.load( 'optimer_regular.typeface.json', function ( response ) {
				var font = response;
				var textGeo = new THREE.TextBufferGeometry( text, {
					font: font,
					size: 100,
					height: 40,
					material: 0,
					extrudeMaterial: 0.01,
					bevelEnabled: true,
					bevelThickness: 0.001,
					bevelSize: 5,
					/*curveSegments: curveSegments,
					*/
				});
				var fancyMaterial = new THREE.MeshPhongMaterial({color: 0xff00ff});
				textMesh = new THREE.Mesh(textGeo, fancyMaterial)
				textMesh.position.z = -1000;
				textMesh.position.y = -500;
				scene.add(textMesh);
				//refreshText();
			} );

			var gradient = [0xFF00FF, 0xF905FC, 0xF40AFA, 0xEF0FF8, 0xEA14F6, 0xE41AF4, 0xDF1FF2, 0xDA24F0, 0xD529EE, 0xD02EEC, 0xCA34EA, 0xC539E8, 0xC03EE6, 0xBB43E3, 0xB648E1, 0xB04EDF, 0xAB53DD, 0xA658DB, 0xA15DD9, 0x9C62D7, 0x9668D5, 0x916DD3, 0x8C72D1, 0x8777CF, 0x827CCD, 0x7C82CA, 0x7787C8, 0x728CC6, 0x6D91C4, 0x6896C2, 0x629CC0, 0x5DA1BE, 0x58A6BC, 0x53ABBA, 0x4EB0B8, 0x48B6B6, 0x43BBB4, 0x3EC0B1, 0x39C5AF, 0x34CAAD, 0x2ED0AB, 0x29D5A9, 0x24DAA7, 0x1FDFA5, 0x1AE4A3, 0x14EAA1, 0x0FEF9F, 0x0AF49D, 0x05F99B, 0x00FF99]

			camera.position.z = 5;

			var fade = 0;
			var threshhold = 65;
			var kal1 = 0;
			var kal2 = 0;
			var rotcount = 0;

			var circleCoutOff = 5;

			var deltatime = new Date();

			animate();

			function animate() {
				var t = new Date();
				var time = t-deltatime;
				//console.log(Math.sin(  rotcount/100 ));
				var dat = analyser.getAverageFrequency();
				var freq = beatanalyser.getFrequencyData();
				var freq2 = leadanalyser.getFrequencyData();
				var arp = arpanalyser.getAverageFrequency();
				var bass = bassanalyser.getFrequencyData();

				console.log(bass);

				if(circleCoutOff<0){
					circleCoutOff = 5;
					circle1.position.set(getRandomPoint(-4,4),getRandomPoint(-4,4),0);
					circle2.position.set(getRandomPoint(-4,4),getRandomPoint(-4,4),0);
					circle3.position.set(getRandomPoint(-4,4),getRandomPoint(-4,4),0);


				}
				if(arp<2){
					circleCoutOff--;
				}
				

				if(freq[0]>threshhold){
					var fr = freq[0]>threshhold+49? threshhold+49 : freq[0];
					fade = (fr-threshhold);
					
				}else{
					cube.material.color.setHex( gradient[0] );
				}

				if(fade>0){
					cube.material.color.setHex( gradient[fade] );
					fade--;
				}

				

				cube.rotation.x += 0.01;
				cube.rotation.y += 0.01;

				if (textMesh) {
					textMesh.position.x -= 5;
				}

				/*if(t-startTime>42000){
					camera.position.x = cube.position.x + 10 * Math.sin(  rotcount/100 );
					camera.position.y = cube.position.y + 10 * Math.cos(  rotcount/100 );
					camera.lookAt( cube.position );
					rotcount++;       
					

				}else if(t-startTime>17000){
                    if(time>450){
						deltatime = new Date();
						randrot();
						
					}
				}else if(t-startTime>50){
					if(time>950){
						deltatime = new Date();
						randrot();
						
					}
					
				}*/

				

				var kal = (kal1+kal2+freq2[0])/3;
				kal1 = kal2;
				kal2 = freq2[0];
				var cubescale = kal/150*3;
				cubescale = cubescale<1? 1 : cubescale;

				var circscale = arp*20;
				
				circscale = circscale<1? 1 : circscale;
				

				cube.scale.set(cubescale,cubescale,cubescale);
				circle1.scale.set(circscale,circscale,circscale);
				circle2.scale.set(circscale,circscale,circscale);
				circle3.scale.set(circscale,circscale,circscale);
				//camera.position.set(bass[0]/100 ,bass[0]/100,5);

				requestAnimationFrame( animate );
				renderer.render( scene, camera );
			}

			function randrot(){
				var ran = Math.floor((Math.random() * 4) + 1);
				switch(ran){
					case 1:
						cube.rotation.x += 1;
						break;
					case 2:
						cube.rotation.x -= 1;
						break;
					case 3:
						cube.rotation.y += 1;
						break;
					case 4:
						cube.rotation.y -= 1;
						break;
				}
			}

			function getRandomPoint(min, max) {
    			return Math.random() * (max - min + 1) + min;
			}

		</script>
	</body>
</html>